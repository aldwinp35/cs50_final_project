<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <title>Ospost | Log In with facebook</title>
    <style>
        h1, h2, h3, h4, h5, p {
            color: #767688;
            margin: 0;
        }

        a, a:hover {
            text-decoration: none;
            color: rgba(22, 131, 255, 0.952);
        }

        body {
            font-family:  "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-image: url('../../static/bg-login.jpg');
            background-size: cover;
            background-position: center center;

            display: flex;
            justify-content: center;
            align-items: center;

            height: calc(100vh - 20px);
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;

            padding: 40px;
            border-radius: 10px;

            background-color: rgba(255, 255, 255, .8);
            box-shadow: -2px 6px 10px 5px rgba(168, 168, 168, 0.4);
        }

        .container h3 {
            margin-bottom: 30px;
        }

        .container img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .container p.header {
            margin-top: 15px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .container a {
            line-height: 1.4;
            font-size: 12px;
        }

        .image-credit, .image-credit:hover {
            color: #fff;
            text-decoration: none;
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
        }

        .privacy, .privacy:hover {
            font-size: 12px;
            text-decoration: none;
            margin-top: 15px;
            font-weight: 600;
            color: #767688;
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="../../static/logo.png" draggable="false" alt="">
        <h3>Log In / Register</h3>

        <!-- Implement Facebook Login Permissions: https://developers.facebook.com/docs/instagram-api/getting-started -->
        <!-- Content Publishing Permissions: https://developers.facebook.com/docs/instagram-api/guides/content-publishing -->
        <div
            class="fb-login-button"
            data-width=""
            data-size="large"
            data-button-type="continue_with"
            data-layout="default"
            data-auto-logout-link="false"
            data-scope="
                email,
                instagram_basic,
                instagram_content_publish"
            data-use-continue-as="false"
            onlogin="checkLoginState();">
        </div>

        <p class="header">Login Requirements:</p>
        <a href="https://help.instagram.com/502981923235522">An Instagram Business Account</a>
        <a href="https://help.instagram.com/399237934150902">A Facebook Page connected to that account</a>

        <a class="privacy mt-3" href="/privacy">See Privacy Policy</a>
    </div>

    <a class="image-credit" href="https://www.freepik.com/">Image designed by Freepik</a>

    <input type="hidden" id="app_id" value="{{ fb.app_id }}">
    <input type="hidden" id="app_version" value="{{ fb.version }}">

    <script>

        const app_id = document.getElementById('app_id');
        const app_version = document.getElementById('app_version');

        window.fbAsyncInit = function() {
            FB.init({
                appId      : app_id.value,
                cookie     : true,
                xfbml      : true,
                version    : app_version.value
            });

            FB.AppEvents.logPageView();
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function checkLoginState(){
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });
        }

        async function statusChangeCallback(response)
        {
            if (response)
            {
                // response.status: specifies the login status of the person using the app.
                // connected - the person is logged into Facebook, and has logged into your app
                if (response.status === 'connected')
                {
                    const accountsInfo = await getAccountsInfo(response.authResponse.accessToken);
                    console.log(accountsInfo);

                    // FB.api('/me?fields=name,email,picture', function (user) {
                    //     if (!user.error)
                    //     {
                    //         user.pages = accountsInfo;
                    //         response.authResponse.user = user;
                    //         const data = response.authResponse;

                    //         fetch('/login', {
                    //             "method": "POST",
                    //             headers: {
                    //                 'Content-Type': 'application/json'
                    //             },
                    //             body: JSON.stringify(data)
                    //         })
                    //         .then(res => res.json())
                    //         .then(data => {
                    //             if (data.success)
                    //             {
                    //                 window.location.reload();
                    //             }
                    //         })
                    //         .catch((error) => {
                    //             console.error('Error:', error);
                    //         });
                    //     }
                    // });
                }
            }
        }

        async function getAccountsInfo(token)
        {
            let info = [];
            const fb_pages = await getFacebookPages(token);

            for (let i = 0; i < fb_pages.length; i++) {
                let account = await getInstagramIdAndUsername(fb_pages[i].id, token);
                if (account !== undefined) {
                fb_pages[i].account = account;
                info.push(fb_pages[i]);
                }
            }

            return info;
        }

        async function getFacebookPages(token)
        {
            let fb_pages = [];
            try
            {
                const req = await fetch(`https://graph.facebook.com/v10.0/me/accounts?access_token=${token}`);
                const res = await req.json();
                res.data.forEach((item) => {
                    let page = {
                        id: item.id,
                        name: item.name,
                        category: item.category
                    };

                    fb_pages.push(page);
                });
            } catch (error) {
                console.log(error);
            }

            return fb_pages;
        }

        async function getInstagramIdAndUsername(pageId, token)
        {
            try
            {
                const req = await fetch(`https://graph.facebook.com/v10.0/${pageId}?fields=instagram_business_account&access_token=${token}`);
                const res = await req.json();
                if (res.hasOwnProperty("instagram_business_account"))
                {
                    const username = await getInstagramUsername(res.instagram_business_account.id, token);
                    return {
                        id: res.instagram_business_account.id,
                        username: username
                    };
                }
            } catch (error) {
                console.log("error: ", error);
            }
        }

        async function getInstagramUsername(accountId, token)
        {
            try
            {
                const req = await fetch(`https://graph.facebook.com/v10.0/${accountId}?fields=username&access_token=${token}`);
                const res = await req.json();
                return await res.username;

            } catch (error) {
                console.log(error);
            }
        }
    </script>
</body>
</html>